;; {{name}} â€” Bonding Curve Token
;; Generated by stxforge-plugin-bonding-curve
;; Price function: price = slope * supply^2

(define-fungible-token {{contractName}})

(define-constant CONTRACT-OWNER tx-sender)
(define-constant ERR-OWNER-ONLY        (err u100))
(define-constant ERR-INSUFFICIENT-STX  (err u101))
(define-constant ERR-ZERO-AMOUNT       (err u102))
(define-constant SLOPE                 u{{slope}})

(define-data-var total-reserve uint u0)

;; Price to buy `amount` tokens given current supply
(define-read-only (get-buy-price (amount uint))
  (let (
    (supply (ft-get-supply {{contractName}}))
    (new-supply (+ supply amount))
  )
    ;; Integral of slope*x from supply to new-supply = slope*(new^2 - old^2)/2
    (ok (/ (* SLOPE (- (* new-supply new-supply) (* supply supply))) u2))
  )
)

;; Price received for selling `amount` tokens
(define-read-only (get-sell-price (amount uint))
  (let (
    (supply (ft-get-supply {{contractName}}))
    (new-supply (- supply amount))
  )
    (ok (/ (* SLOPE (- (* supply supply) (* new-supply new-supply))) u2))
  )
)

;; Buy tokens by sending STX
(define-public (buy (amount uint))
  (let ((price (unwrap! (get-buy-price amount) (err u500))))
    (asserts! (> amount u0) ERR-ZERO-AMOUNT)
    (try! (stx-transfer? price tx-sender (as-contract tx-sender)))
    (var-set total-reserve (+ (var-get total-reserve) price))
    (ft-mint? {{contractName}} amount tx-sender)
  )
)

;; Sell tokens and receive STX
(define-public (sell (amount uint))
  (let ((proceeds (unwrap! (get-sell-price amount) (err u500))))
    (asserts! (> amount u0) ERR-ZERO-AMOUNT)
    (try! (ft-burn? {{contractName}} amount tx-sender))
    (var-set total-reserve (- (var-get total-reserve) proceeds))
    (as-contract (stx-transfer? proceeds tx-sender tx-sender))
  )
)

(define-read-only (get-reserve) (ok (var-get total-reserve)))
(define-read-only (get-supply)  (ok (ft-get-supply {{contractName}})))
