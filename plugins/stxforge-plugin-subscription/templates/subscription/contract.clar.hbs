;; {{name}} Subscription â€” On-chain Recurring Payments
;; Generated by stxforge-plugin-subscription

(define-constant CONTRACT-OWNER   tx-sender)
(define-constant PRICE            u{{pricePerPeriod}})
(define-constant PERIOD           u{{periodBlocks}})
(define-constant GRACE-PERIOD     u{{gracePeriod}})
(define-constant ERR-OWNER-ONLY   (err u100))
(define-constant ERR-NOT-SUB      (err u101))
(define-constant ERR-ALREADY-SUB  (err u102))
(define-constant ERR-EXPIRED      (err u103))

;; subscriber -> expiry block height
(define-map subscriptions principal uint)

;; Subscribe for one billing period
(define-public (subscribe)
  (let (
    (expiry (+ block-height PERIOD))
    (existing (map-get? subscriptions tx-sender))
  )
    (asserts! (is-none existing) ERR-ALREADY-SUB)
    (try! (stx-transfer? PRICE tx-sender CONTRACT-OWNER))
    (map-set subscriptions tx-sender expiry)
    (ok expiry)
  )
)

;; Renew an existing subscription for one more period
(define-public (renew)
  (let (
    (current-expiry (unwrap! (map-get? subscriptions tx-sender) ERR-NOT-SUB))
    (new-expiry (+ (max current-expiry block-height) PERIOD))
  )
    (try! (stx-transfer? PRICE tx-sender CONTRACT-OWNER))
    (map-set subscriptions tx-sender new-expiry)
    (ok new-expiry)
  )
)

;; Cancel and remove subscription record
(define-public (cancel)
  (begin
    (asserts! (is-some (map-get? subscriptions tx-sender)) ERR-NOT-SUB)
    (map-delete subscriptions tx-sender)
    (ok true)
  )
)

;; Check if a principal has an active subscription (including grace period)
(define-read-only (is-active (subscriber principal))
  (match (map-get? subscriptions subscriber)
    expiry (ok (<= block-height (+ expiry GRACE-PERIOD)))
    (ok false)
  )
)

;; Get subscription expiry block for a principal
(define-read-only (get-expiry (subscriber principal))
  (ok (map-get? subscriptions subscriber))
)

;; Owner withdraws accumulated STX
(define-public (withdraw (amount uint))
  (begin
    (asserts! (is-eq tx-sender CONTRACT-OWNER) ERR-OWNER-ONLY)
    (as-contract (stx-transfer? amount tx-sender CONTRACT-OWNER))
  )
)
